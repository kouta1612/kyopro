
(諸事情により、Qiitaよりこの記事を移植いたしました。Qiitaでストックにこの記事を入れていた方やリンクを貼っていた方々にご迷惑をおかけすることお詫び申し上げます。)

Rho17と申します。
私は競技プログラミングが趣味で、AtCoderのコンテストに主に参加しています。

ところで、皆さんはいわゆる「数え上げ」と呼ばれる問題は好きですか？私は好きですが、それが苦手で敬遠しているという方も多くいらっしゃることと思います。そこで今回は、数え上げを恐れずにすむために数え上げに対する考え方を記します。

初めに、この記事は[DEGwer氏の数え上げPDF](http://degwer.hatenablog.com/entry/20171220)より簡単な部分の解説に焦点を絞ります。想定としては茶色~青前半くらいです。より高度な内容はそちらをご参照ください。

[:contents]

# 0.はじめに
そもそも数え上げとは、ある条件を満たす何かが何通りあるか調べる問題です。この「何か」は多岐にわたり、一概に解法をまとめづらいのも数え上げが難しいと言われる原因の一つでしょう。
しかし、ある程度なら何を考えるべきかはかなり絞られます。この記事では筆者が数年競技プログラミングに取り組んできて感じた数え上げの定石や考え方を解説したいと思います。

なお、以後は剰余計算を断りなく使用します。もし剰余の計算に不安がある場合は以下の記事をご参照ください。

- [「1000000007 で割ったあまり」の求め方を総特集！ 〜 逆元から離散対数まで 〜](https://qiita.com/drken/items/3b4fdf0a78e7a138cd9a#4-%E7%B4%AF%E4%B9%97-an) by @drken

# 1. 数え上げの基本
数え上げの2つの原則は

- もれなく
- 重複なく

数えることです。つまり、条件を満たす要素はすべてただ1度だけ数えられていなければなりません。以下のような問題を考えてみましょう。

<blockquote>
$N$枚のカードがあり、$i$番目のカードには$A_i$が書かれている。<br>
T君はこの中から$2$枚を同時に抜き出す。取り出されたカードに書かれた数字のペアは何通りあるか。<br>
ただし、$(1,2)$と$(2,1)$のような順序を入れ替えただけのペアは区別しない。
</blockquote>

例えば$N=5$, $\\{A\\}=\\{1,2,2,3,4\\}$の場合を考えてみましょう。この場合は$(1,2),(1,3),(1,4),(2,2),(2,3),(2,4),(3,4)$の$7$通りのペアがあります。
しかし、$5$枚の中から$2$枚選ぶ通り数として${}\_5 \mathrm{C} \_2$としてしまうと、答えは$10$通りとなってしまい不正解です。この間違いは$(1,2),(2,3),(2,4)$のペアを$A\_2$の$2$と$A\_3$の$2$でそれぞれ2回ずつ数えたことによります。
数え上げにおいて、重複の補正は困難な場合が多いです。そのため、できるだけ被らないように数える必要があります。具体的にどのように数えるかは次章以降で扱います。
# 2 全探索を利用した数え上げ
この章では、ある状態を列挙して条件を満たすかどうか判定する方法をベースに解説します。

## 2-1. 全探索ベースの数え上げ

まず基本となるのは、全ての場合について条件を満たすかどうか判定し、条件を満たす場合の数を数えるというものです。全ての場合を網羅するので、漏れや重複は基本起こりません。例題を見てみましょう。

<blockquote>
$N$個のスイッチと$M$個の電球がある。各スイッチはonとoffの状態がある。<br>
電球$i$は$k_i$個のスイッチ$s_{i1}...s_{in}$に繋がっており、繋がっているスイッチの個数を$2$で割った余りが$p_i$のとき点灯する。<br>
全ての電球が点灯する<strong>スイッチの組み合わせ</strong>は何通りか?<br>
制約 : $1 \leq N,M \leq 10$<br>
(出典 : <a href="https://atcoder.jp/contests/abc128/tasks/abc128_c"> ABC128-C </a>)
</blockquote>

スイッチのon/offの状態は$2^{10}=1024$通りなので状態を全て列挙することができます。スイッチのon/offを固定したとき、全ての電球がつくかは$O(NM)$で判定でき、十分間に合います。状態の列挙は状態をbitにエンコードすることで簡単に探索できます。

このように、探索すべき状態を全て試す方法はほとんど確実です。以下に練習問題を掲載します。

**1**  [ABC147-C HonestOrUnkind2](https://atcoder.jp/contests/abc147/tasks/abc147_c) 上と同じ発想で解けます。

## 2-2. 何かを固定して数え上げる

先ほどはありえる全ての場合を列挙していました。しかし、全事象の個数が多すぎると全ての場合を数えるのに時間がかかりすぎてしまい、TLEすることがよくあります。そこで、探索範囲を減らして数え上げる手法を考えます。以下の問題を考えてみましょう。

<blockquote>
$0$以上$K$以下の整数$X,Y,Z$について、$X+Y+Z=S$となるような組み合わせは何通りか。<br>
制約 : $0 \leq K,S \leq 5000$<br>
(出典 : <a href="https://atcoder.jp/contests/abc051/tasks/abc051_b"> ABC051-B </a>)
</blockquote>

$X,Y,Z$を全探索してしまうと計算量は$O(K^3)$となりますが、$K \leq 5000$なのでおよそ$1.2 \times 10^{11}$ 回の計算が必要となりTLEしてしまいます。
探索の様子を観察してみると、無駄な探索が多いことが分かります。たとえば、$S=10$のときに$(X,Y,Z)=(1,1,1)$のような組は明らかに関与しません。
ここで、探索範囲を狭めてみます。

固定する要素を$X,Y$の2要素に限定してみます。すると、未定な変数は$Z$のみとなります。そこで上式の変数と定数を分離すると、$$Z=S-X-Y$$
となります。このとき$Z$の値は一意に定まります。
$X,Y,Z$の3要素を固定した場合には各場合について「$X+Y+Z$が$S$と等しいか?」という判定をしていました。一方、今回の場合では「$Z$は$0$以上$K$以下か?」という判定をすればよいことになります。この判定は$O(1)$でできるので、この問題全体で $O(K^2)$ で解けました。

このように、ある部分を固定して考えることは重要です。ある部分を固定したときに他のパラメータが同時に定まったり絞られたりし、そのときの場合の数を高速に数えられる場合に有効です。

------------
ここで、もう一問「ある部分を固定して考える」練習をしてみましょう。

<blockquote>
長さ$N$の数列$A$が与えられる。<br>
整数の組$(l,r)$で、$A_{l}+A_{l+1}...+A_{r}=0$を満たすような組は何通りか?<br>
制約 : $1 \leq N \leq 10^5$
(出典 : <a href="https://atcoder.jp/contests/agc023/tasks/agc023_a">AGC023-A Zero Sum Ranges</a>)
</blockquote>

区間和を求めているので、累積和を取ってみます。$S_0=0,S\_{i}=S\_{i-1}+A_i (1 \leq i \leq N)$として定義します。
累積和を用いて上の式を変形すると、 $S\_{r}-S\_{l-1}=0$ という式が出てきます。これを少し変形すれば、
$$S\_{r}=S\_{l-1}$$ となり、これを満たす組を数えればよいことになります。

さて、$l$と$r$を全探索していては $l,r\leq 10^5$ なのでTLEしてしまいます。ここで「何かを固定する」考えが生きてきます。

$l$を固定してみます。すると各$l$について求めるものは「 $S_{l-1}=S_{r}$ かつ $l-1<r$ 」を満たす $r$ の個数です。つまり、ある要素から見て右にある自分と等しい要素の数です。これを求めるのはmapを用いて各数が何回出てくるか記録し、ある要素を通り過ぎたらその要素の個数を1減らすと更新することで可能です。

--------
この問題ではある部分を固定した後、残りの部分を決定する問題を高速に解くことで全体の計算量を落としました。
以下の練習問題もほぼ同じような発想の流れで解くことができます。

- **2** [diverta 2019-B RGB Boxes](https://atcoder.jp/contests/diverta2019/tasks/diverta2019_b) 上と同じ発想で解けます。

- **3**[三井住友-D Lucky PIN](https://atcoder.jp/contests/sumitrust2019/tasks/sumitb2019_d) 3要素に増えました。3要素のときは中央を固定するとうまくいくことが多いです。

- **4**[JOI本選2019-1 勇者ビ太郎](https://atcoder.jp/contests/joi2019ho/tasks/joi2019ho_a)

ある部分を固定した後、条件を満たす部分を「まとめて」数え上げる問題です。どのようにしてまとめるとうまくいくでしょうか?

- **5** [技術室奥4-B 新入生歓迎数列2](https://atcoder.jp/contests/tkppc4-2/tasks/tkppc4_2_d) **3**と**4**の融合です。

- **6**[ARC043-B 難易度](https://atcoder.jp/contests/arc043/tasks/arc043_b) 今までの考察を用いれば固定する要素を2要素に絞るまでは見えるはずです。そこから計算量を落とす工夫が難しいです。

# 3. 積の法則の利用
基本となる考えは樹形図の考え方です。積の法則は「事象$X$が起こる通り数が$m$通りあり、それぞれに対して事象$Y$が起こる通り数が$n$通りあれば両方が起こる通り数は$mn$通りになる」という説明がなされます。

## 3-1. 積の法則
上の説明をもう少し詳しく見てみましょう。以下の問題を考えてみます。
<blockquote>
$N$個の街が西から東へ$1,2,...N$と並んでいる。街$i$から$i+1$へ行く道路があり、$a\_i$種類から選ぶことができる。<br>
あなたは今街$1$にいる。全ての街を$1$から$N$まで順に訪れるとき、道路の選び方は何通りか。$10^9+7$で割った余りを求めよ。
</blockquote>

![kazoeage1.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/590571/441f639e-35c0-57cc-bbb6-49131dbf84d8.png)

$1$番目の街から$2$番目の街に移動する方法は$a\_1$通りです。$2$番目の街から$3$番目の街に移動する方法は$a\_2$通りです。

ここで積の法則を適用することで、$1$番目の街から$3$番目の街まで移動する方法が$a\_1 \times a\_2$通りであることが分かります。
以後同様にすることで、最終的な通り数は$a\_1 \times a\_2 ... \times a\_{n-1}$通りであることが分かります。
直感的には、最初の地点から$a_1$通りの分岐があり、さらにそれぞれについて$a\_2$通りの分岐があり...と繰り返すことで分かります。

---------

もう少し実践的な問題で考えてみましょう。 (20/03/15 追加)

<blockquote>
長さ$N$の文字列$S$が与えられます。$S$の部分列であって、すべて異なる文字からなるものの数を$10^9+7$で割った余りを答えてください。<br>
文字列として同一でも、異なる位置から取り出された部分列は区別して数えることとします。<br>

ただし、文字列の部分列とは、文字列から文字をいくつか<strong>正の個数</strong>取り出し、もとの文字列から順序を変えずにつなげたものを指します。<br>
制約: $N \leq 10^5$
</blockquote>
例えば元の文字列が`"baa"`のとき、`"b"` , `"ba"` , `"ba"` , `"a"` , `"a"` の5通りがありえます。

各文字について分類します。ある文字について、その文字を部分列に採用しない場合は$1$通りです。また採用する場合、その文字が$c$個あったときは$c$通りの取り出し方があります。結局各文字の個数を$c\_i$として$c\_i+1$を全て掛け合わせたものが部分列の個数です。

上の例では、`a`が2個と`b`が1個あるので$2 \times 3 =6$通りの取り出し方があります。
最後に1個も選ばない場合1通りを除いて答えが得られます。

積の法則の基本的な考え方は「それぞれに対し何通りあるか」です。それを念頭に以下の例題を解いてみてください。

- **7** [DDCC予選2018-A チップ・ストーリー　～無色編～](https://atcoder.jp/contests/ddcc2019-qual/tasks/ddcc2018_qual_a)

- **8** [ARC076-C Reconciled?](https://atcoder.jp/contests/arc076/tasks/arc076_a)

 $N$個のものを1列に並べる通り数は$N \times (N-1) ...\times 1$です。

- **9** [keyence2019-D Double Landscape](https://atcoder.jp/contests/keyence2019/tasks/keyence2019_d)

考察が少し難しいです。

## 3-2. 二項係数の利用

$N$個の中から$K$個を選ぶ通り数を基本とする問題です。この通り数を${}\_N \mathrm{C} \_K$と表記し、$\frac{N!}{K!(N-K)!}$で計算できます。また、二項係数とも呼ばれる場合があります。
以下に二項係数の基本性質を列挙します。

- ${}\_N \mathrm{C} \_K={}\_N \mathrm{C} \_{N-K}$

- ${}\_{N+1} \mathrm{C} \_{K+1}={}\_N \mathrm{C} \_K+{}\_N \mathrm{C} \_{K+1}$

- $\sum_{i=0}^{N}{}\_N \mathrm{C} \_i=2^N$

これらは二項定理やパスカルの三角形から従います。

二項係数を用いる時は何を区別して何を区別しないのかに細心の注意を払う必要があります。以下の問題で雰囲気を察していただければと思います。

- **10** [ABC159-A The Number of Even Pairs](https://atcoder.jp/contests/abc159/tasks/abc159_a)

2個選ぶ方法とは？区別するべきものが何かを考える初歩です。

- **11** [ABC156-D Bouquet](https://atcoder.jp/contests/abc156/tasks/abc156_d)

二項係数の使い方の基本です。計算方法に工夫が必要です。

- **12** [ABC145-D Knight](https://atcoder.jp/contests/abc145/tasks/abc145_d)

少し変形すれば何かに帰着できます。

- **13** [ABC110-D Factorization](https://atcoder.jp/contests/abc110/tasks/abc110_d)

素因数分解との組み合わせです。**重複組み合わせ**が出てきます。

$N$個の区別できる箱に$K$個の区別できないものを入れる組み合わせ数は重複組み合わせと呼ばれ、${}\_{N+K-1}\mathrm{C}\_{K}$で計算できます。これは$K$個のものに$N-1$本の仕切りを立てる場合の数に対応されます。

- **14** [ABC132-D Blue and Red Balls](https://atcoder.jp/contests/abc132/tasks/abc132_d)

区別しないものは何かを考える必要があります。

## 3-3. 経路数との対応
突然ですが、以下の問題を考えてみましょう。

>格子点上の点を$(0,0)$から$(N,M)$まで最短で移動する方法は何通りか。
>制約 : $1 \leq N,M \leq 10^5$

これは$x$座標が増える方向に$N$回と$y$座標が増える方向に$M$回進む動作を行う操作数と等しく、${}\_{N+M} \mathrm{C} \_{N}$で計算できます。このように、二項係数とグリッド上の経路の間には深い関係があります。ここで次の問題を考えてみましょう。

<blockquote>
格子点上の点を$(0,0)$から$(N,N)$まで、$j \leq i$なる点$(i,j)$のみを通って最短で行く方法は何通りか。<br>
制約 : $1 \leq N \leq 10^5$
</blockquote>

この問題をグリッド上経路に帰着させて考えてみましょう。

条件に違反する経路数を数えます。そのような経路は必ず$(i,i+1)$として表される点を通っています。
![kazoeage2.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/590571/c740c4a9-0990-b175-1f9a-2d416cada3b9.png)
ここで全ての$i$に対し$(0,0)→(i,i+1)→(N,N)$という経路を直線$y=x+1$に対して対称移動させるとその経路は全て点$(N-1,N+1)$へ集まります。
逆に、$(0,0)$から$(N-1,N+1)$へ移動する全ての経路を$y=x+1$に対して対称移動すると$(N,N)$へ向かう違反する経路だけが生成されます。

よって、違反する経路数は${}\_{2N} \mathrm{C} \_{N-1}$と数えられ、全ての経路数から引くことで求めるものは${}\_{2N} \mathrm{C} \_N - {}\_{2N} \mathrm{C} \_{N-1}$であるとわかりました。

- **15** [ABC154-F Many Many Paths](https://atcoder.jp/contests/abc154/tasks/abc154_f)

これもグリッドに帰着させると見通しがよくなります。

- **16** [AGC001-E BBQ Hard](https://atcoder.jp/contests/agc001/tasks/agc001_e)

1400点の難問です。制約を使ってグリッドに帰着させます。

# 4. DPの利用
第2章後半で述べた計算量の削減の方法は他にもあります。よく使われるのは、DP(動的計画法)を用いて複数の状態をまとめ、計算量を落とす解法です。まずは最も有名な問題の一つを見てみましょう。

<blockquote>
$N$要素の数列$\{A_i\}$がある。この中から$0$個以上を選び、その和を取る。この操作によって得られる数は何通りあるか。<br>
制約 : $1 \leq N \leq 100, 0 \leq A_i \leq 100$
</blockquote>

愚直にやると$2^N$かかってしまいます。ここではとりうる値の少なさに注目して状態をまとめます。

$i$番目までの数の集合で作れる要素は高々$2^i$ですが、実際は鳩ノ巣原理より$100i$個程度が上限です。ここで、$$dp[i][j]=i番目までの集合で総和をjにする通り数$$と定義します。さて、ここで$i+1$番目の要素を追加することを考えます。

この要素を総和に組み込まないときは総和は変化しません。また、この要素を総和に組み込むときは総和は$A\_{i+1}$増加します。このことから、$$dp[i+1][j]=dp[i][j]+dp[i][j-A\_{i+1}]$$という式が成立します。($dp[i][j]$が総和に要素を組み込まないとき、$dp[i][j-A\_{i+1}]$が総和に要素を組み込むときに対応します)

-------

もう一問別の問題を見てみましょう。
<blockquote>
長さ$N$の文字列があり、その文字列は <code>'('</code> か <code>')'</code> か <code>'?'</code> である。以下のような操作を行う。<br>
<ul>
<li>文字列中の全ての<code>'?'</code>について、それらを<code>'('</code>か<code>')'</code>で置き換える。</li>
<li>文字列中に<code>"()"</code>という連続する部分文字列があったら、それを削除する。削除した部分は詰められる。
この操作は文字列中から<code>"()"</code>がなくなるまで行う。
</ul>
以上の操作を行ったとき残った文字列の長さを元の文字列のスコアと定義する。<br>
<code>'?'</code>に対する文字の割り当て方は<code>'?'</code>の数を$T$として$2^T$通り存在する。そのそれぞれに対し文字列のスコアを求め、その総和を$\mathrm{mod}10^9+7$で求めよ。<br>
制約 : $1 \leq N \leq 300$
</blockquote>

求めるものが通り数から総和へと変わっていますが、基本的な考え方は同じです。何を用いて情報をまとめるかを考察します。
操作中の文字列に対しても、<code>"()"</code>という部分があればそれを消してしまって問題ないことが分かります。よって、操作中の文字列は<code>')'</code>を$i$個と<code>'('</code>を$j$個連結した文字列になります。

さて、$n$文字目までで<code>')'</code>が$i$文字と<code>'('</code>が$j$文字ある状況を考えます。また、DPテーブルには「この状態に至るまで何通りか」を持たせます。
総合して、$dp[n][i][j]=n$文字目までで<code>')'</code>が$i$文字,<code>'('</code>が$j$文字続いている文字列になっている場合の数とします。
すると、$n+1$文字目を追加したときの通り数も適切な遷移によって求めることができます。

全ての通り数を求めた後、さらにスコアを求める必要があります。しかし、$dp[n][i][j]$の定義より、$dp[n][i][j]$通りの文字列はいずれも長さ$i+j$です。これを用いて正しい答えを得ることができます。

---------

一般に、DPは適切な場合分けをして情報をまとめることが重要です。情報のまとめ方はad-hocな部分が大きく一概にはくくれませんが、状態数が多くなさそうな部分やもう見なくてよい部分に着目するとうまくいく印象があります。練習問題を解いて感覚を養うのが効果的でしょう。

- **17** [EDPC-A Frog 1](https://atcoder.jp/contests/dp/tasks/dp_a)

これに限らずEDPCは非常に教育的なので他の問題も解くことを強く推奨します。

- **18** [CODE FESTIVAL 2018 qual A-C 半分](https://atcoder.jp/contests/code-festival-2018-quala/tasks/code_festival_2018_quala_c)

どのように情報をまとめるかが問題です。複数のパラメータが必要になることもあります。

- **19** [ABC158-F Removing Robots](https://atcoder.jp/contests/abc158/tasks/abc158_f)

前処理が少々重いですが、その先のDPパートは典型的です。「この状態に至るまでの通り数」みたいなものを所持します。

- **20** [ABC132-F Small Products](https://atcoder.jp/contests/abc132/tasks/abc132_f)

DPの持ち方自体は素直ですが、実装と頭の整理が大変です。

- **21** [ARC059-F バイナリハック](https://atcoder.jp/contests/arc059/tasks/arc059_d)

エキセントリックな状態の持ち方をする方法と、そこまで非自明でもない見方をする方法の2通りがあります。

情報をまとめるという点について、巷で特殊な名前で呼ばれるDPと組み合わせることは多々あります。

- **22**[EDPC-P Independent Set](https://atcoder.jp/contests/dp/tasks/dp_p)

木DPとの融合です。適切な場合分けが必要です。

- **23**[ABC135-D Digits Parade](https://atcoder.jp/contests/abc135/tasks/abc135_d)

整数を上の桁から走査する、いわゆる**桁DP**の亜種です。

- **24**[JOI予選2012-6 ジグザグ数](https://atcoder.jp/contests/joi2012yo/tasks/joi2012yo_f)

見た目からやることは見えますが、適切な場合分けと実装がかなり困難です。

- **25**[ABC021-C 正直者の高橋くん](https://atcoder.jp/contests/abc021/tasks/abc021_c)

ダイクストラ法との組み合わせです。頂点$u→v$において、$dist[u]+cost\_{uv}<dist[v]$の時は最短経路の通り数$dp[v]=dp[u]$となるのに対し、$dist[u]+cost\_{uv}==dist[v]$の時は$dp[v]{\bf+=}dp[u]$となることに注意してください。

- **26**[パ研合宿Day4-E IOIのために](https://atcoder.jp/contests/pakencamp-2019-day4/tasks/pakencamp_2019_day4_e)

基本は**25**とほぼ同じで、考察が1つ入ります。

# 5. 寄与分の計算

ある要素が解答にどれほど寄与するかをそれぞれ求める方法です。詳しく言えば、ある要素の影響が何回足されるかを求めることで答えを計算します。これも例題を用いて解説します。

>長さ$N$の数列$\{A\}$が与えられる。その中から$K$個を選んだ集合を$S$とし、$(Sの最大値) - (Sの最小値)$をスコアとする。
>${}\_{N}\mathrm{C}\_{K}$通りのスコアの総和を$\mathrm{mod} 10^9+7$で求めよ。
>制約 : $1 \leq N \leq 10^5 , |A\_i| \leq 10^9$
>(出典 : [ABC151-E](https://atcoder.jp/contests/abc151/tasks/abc151_e))

${}\_{N}\mathrm{C}\_{K}$通り調べ上げるのは不可能です。まず、最大値と最小値を分解して別々に求めます。($Σ(max(S)-min(S))=Σmax(S)-Σmin(S)$が成り立つので)

求めるものを$N$個の要素から$K$個選んだ時の最大値の総和に変換できました。総和を求める際に、「要素$X$を最大値として選ぶ場合の数」を求めて$X$倍したものを足し合わせます。(この部分が寄与分の計算です)
$\{A\}$をソートした中で要素$X$が小さい方から$x$番目に来ていたとき、残り$K-1$個の要素を$x-1$個の$X$より小さい要素から選び出せばよいです。
よって、$X$を最大値として選ぶ通り数は${}\_{x-1}\mathrm{C}\_{K-1}$となります。最小値の場合もほとんど同じように計算できます。

このテクは期待値を求める際によく使われる印象があります。
さらに詳しく知りたい方は[こちら](https://physics0523.hatenablog.com/entry/2020/01/12/052513)(physics0523氏の記事)を参照ください。

- **27**[AGC028-B Removing Blocks](https://atcoder.jp/contests/agc028/tasks/agc028_b)

総和と期待値は互いに行き来できます。この場合は総和→期待値です。

- **28** [ABC127-E Cell Distance](https://atcoder.jp/contests/abc127/tasks/abc127_e)

やや難しめです。

# 6. その他よく使うテクニック集
この辺りのテクニックを要求する問題は難しいものが多いので、読み飛ばしていただいても問題ありません。AtCoderでは500点の難しい方や600点あたりからこの辺が要求される印象があります。

## 6-1. 重なりを取り除く
重なりの除去は基本的に難しいことが多いのですが、 特殊なケースでは補正が行えることがあります。

- **29** [ARC077-D 11](https://atcoder.jp/contests/arc077/tasks/arc077_b)

余分な要素が1つ入っているパターンです。簡単めです。

- **30** [Tenkka1 2019-D Three Colors](https://atcoder.jp/contests/tenka1-2019/tasks/tenka1_2019_d)

ステップが3段階ほどあって大変です。

また、包除原理を適用することも重なりの補正の一つです。

- **31** [EDPC-Y Grid 2](https://atcoder.jp/contests/dp/tasks/dp_y)

**31**のような集合の話題に関連して、「Aではない」ものを数える時に全体からAであるものを引くという考えをすることは有力です。数えにくいと思ったときは余事象を取ってみるのも一つです。

- **32** [ARC090-E Avoiding Collision](https://atcoder.jp/contests/arc090/tasks/arc090_c)
数え上げパート自体は難しすぎることはありません。

## 6-2. 適切な場合分け
DPにおいて遷移の際に何らかのルールを定め、重複を防ぐテクニックです。例えば部分列DP[^1]では、ある文字に遷移するとき最も近い文字へ遷移するというルールを定めることで、重複を防止しています。

[^1]: 部分列DPに関して詳しくは[こちら](https://qiita.com/drken/items/a207e5ae3ea2cf17f4bd)(@drken氏)の記事にあります。

下の例は部分列が1つと部分列ではないが同じ発想をするものが1つです。

- **33** [BBC003-E 何でもダガー打ちゃいいってもんじゃねぇぞ†2020](https://www.hackerrank.com/contests/bbc003/challenges/bbc003-e)

状態が少し増えます。

- **34** [AGC013-D Piling Up](https://atcoder.jp/contests/agc013/tasks/agc013_d)

重複に気づけるかが最初のステップです。

## 6-3. 条件の言い換え
よくわからない操作を言い換えて数えやすい条件に落とし込む問題です。特に多いのが、「ある条件を満たしているものは全て作れる」問題です。
このような問題は得てしてad-hocな考察を要求し、難しい傾向にあります。しかし、このパートが数え上げの華でもあります。
「数え上げられる形」を目指して変形や言い換え、良い性質探しなどを行うとうまくいきやすいですが、基本は精進あるのみです。

- **35** [JSC2019-C Cell Inversion](https://atcoder.jp/contests/jsc2019-qual/tasks/jsc2019_qual_c)

言い換えの中では良心的な考察量です。

- **36** [みんなのプロコン2019-F Pass](https://atcoder.jp/contests/yahoo-procon2019-qual/tasks/yahoo_procon2019_qual_f)

エスパーで通ってしまうことも十分あり得ます。「信じる心」は時折重要になります。

- **37** [AGC036-C GP 2](https://atcoder.jp/contests/agc036/tasks/agc036_c)

これも条件がいくつか出てきます。

- **38**[AGC040-C Neither AB nor BA](https://atcoder.jp/contests/agc040/tasks/agc040_c)

最初に数えやすい条件に言い換える必要がありますが、それが難しいです。数え上げパートももう一段言い換えが必要で大変です。

## 6-4. 対称性を用いる
まずは以下の問題に目をお通しください。

<blockquote>
$N$枚の赤いカードがあり、$1,2,...N$が書かれている。また$N$枚の青いカードがあり、$1,2,...N$が書かれている。これら$2N$枚の並べ方で、以下の条件を満たすものは何通りあるか。<br>
<ul>
<li>$i$が書かれたカードについて、赤い方が青い方より左にある。 </li>
</ul>
</blockquote>

全ての順列のうち、$1$が書かれた赤いカードが$1$が書かれた青いカードより左にある通り数は全体の半分です。全ての整数に関して同じことが言えるので、求める場合の数は$\frac{2N!}{2^N}$となります。

- **39** [AGC037-B RGB  Balls](https://atcoder.jp/contests/agc037/tasks/agc037_b)

最初に対称性を見つけたときや操作の順序が局面に影響しない場合、答えを適切な数で割ったものを代わりに求めることで考察が楽になります。また、sampleを適切な係数で割ってあげることで実験やエスパーが楽になります。

## 6-5 DPの遷移式を変形する
遷移式を書いて睨むと高速に遷移ができるタイプの問題です。

- **40** [EDPC-R Walk](https://atcoder.jp/contests/dp/tasks/dp_r)

$K \leq 10^{18}$でできることといえば...?

## 6-6 ToDo
筆者がまだ解けていないものがここに入ります。打消し線は筆者が解けたものです。
ARC系

- [何とかなりそう](https://atcoder.jp/contests/arc102/tasks/arc102_c)

- [未だによくわかってない](https://atcoder.jp/contests/dwacon6th-prelims/tasks/dwacon6th_prelims_c)

- [期待値 xy方向ってばらせるのかな](https://atcoder.jp/contests/keyence2019/tasks/keyence2019_f)

- [包除らしい](https://atcoder.jp/contests/arc101/tasks/arc101_c)

- [見た目が恐ろしい](https://atcoder.jp/contests/diverta2019-2/tasks/diverta2019_2_e)

- [すべてが恐ろしい](https://atcoder.jp/contests/tenka1-2019/tasks/tenka1_2019_f)

- [~~？？？~~](https://atcoder.jp/contests/caddi2018/tasks/caddi2018_d) ad-hoc系数え上げ　楽しい

AGC系

- [6-5に載せたかった](https://atcoder.jp/contests/agc013/tasks/agc013_e)

- [見た目が絶望的](https://atcoder.jp/contests/agc024/tasks/agc024_e)

- [mod3だろうけど...](https://atcoder.jp/contests/agc027/tasks/agc027_e)

- [おそらく手数が異常に多い](https://atcoder.jp/contests/agc008/tasks/agc008_e)

- [経路数1](https://atcoder.jp/contests/agc021/tasks/agc021_e)

- [経路数2](https://atcoder.jp/contests/agc018/tasks/agc018_e)

- [経路数3](https://atcoder.jp/contests/agc019/tasks/agc019_f)

- [考察](https://atcoder.jp/contests/agc009/tasks/agc009_e)

- [~~1000だし解いておきたいが何もわからない~~](https://atcoder.jp/contests/agc030/tasks/agc030_d)

総和→期待値 寄与分の練習によい

# 7 おわりに
数え上げの問題を解く際の思考として使うものを上で大方列挙しました。この記事で数え上げに対する恐怖心が少しでも薄れるようになればと思います。
kazoeage.md
kazoeage.md を表示しています。
